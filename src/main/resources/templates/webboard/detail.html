<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
<th:block th:replace="~{/layout/basicLayout :: setContent(~{this::content2} )}">
<th:block th:fragment="content2">
		<h1>게시글 상세보기</h1>
		<form th:action="@{/webboard/modify}" th:method="POST">
		<div class="form-group">
			<label>BNO</label>
			<input type="text" class="form-control" th:value="${board.bno}" name="bno" readonly>
		</div>
			<div class="form-group">
				<label>제목</label>
				<input type="text" class="form-control" name="title" th:value="${board.title}"/>
			</div>
			<div class="form-group">
				<label>내용</label>
				<textarea name="content" class="form-control" rows="5" cols="20">[[${board.content}]]</textarea>
			</div>
			<div class="form-group">
				<label>작성자ID</label>
				<input type="text" class="form-control" name="mid" th:value="${board.mid}" readonly/>
			</div>
			<div class="form-group">
				<label>작성일</label>
				<input type="text" class="form-control" th:value="${board.regdate}" readonly/>
			</div>
			<div class="form-group">
				<label>수정일</label>
				<input type="text" class="form-control" th:value="${board.updatedate}" readonly/>
			</div>
			<button type="submit" class="btn btn-primary">수정</button>
		</form>
		<button type="button" class="btn btn-primary btnDelete">삭제</button>
		
		<!-- 댓글 추가 -->
		<div>
		     <div class="mt-4">
		     <h5><button type="button" class="btn btn-primary">
		         <span class="badge badge-secondary addReply">Add  Reply</span>
		         </button>
		       </h5>
		       <h5><button type="button" class="btn btn-primary">
		         <span class="badge badge-secondary replyCount">Reply Count : [[${board.replyCount}]]</span>
		         </button>
		       </h5>
		     </div>
		     <div class="list-group replyList">
		     </div>
	   </div>
	   
	   <!--Modal: 댓글을 추가하거나 상세보기할 때 사용할 예정 -->
	   <div class="modal" tabindex="-1" role="dialog">
             <div class="modal-dialog" role="document">
               <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">등록/수정</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                      <input class="form-control" type="text" name="replyText" placeholder="댓글"/>
                      <input class="form-control" type="text" name="replyer" placeholder="작성자"/>
                      <input  type="hidden" name="rno" >
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning replyModify">수정</button>
                    <button type="button" class="btn btn-primary replySave">입력</button>
                    <button type="button" class="btn btn-danger replyRemove">삭제</button>
                    <button type="button" class="btn btn-outline-secondary replyClose" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
        </div>
		</th:block>
	</th:block>
	<script th:inline="javascript">
		var boardBno = /*[[${board.bno}]]*/0;
		
		$(".replySave").click(f_insertReply);
		$(".replyCount").click(f_selectReplies);
		
		$(".replyList").on("click", ".card-body", f_replyModify);
		$(".replyModify").on("click", f_replyModifyDB);
		$(".replyRemove").on("click", f_replyDeleteDB);
		
		function f_replyDeleteDB() {
			var rno = $("input[name='rno']").val();
			$.ajax({
				url: "/replies/delete/" + rno,
				method: "DELETE",
				success: function(resData) {
					if(resData == "success"){
						alert("댓글 삭제됨");
						$('.modal').hide();
						f_selectReplies();
					}
				},  error: function(e){
					console.log(e);
				}
			});
		}
		
		function f_replyModifyDB() {
			var reply = $("input[name='replyText']").val();
			var replyer = $("input[name='replyer']").val();
			var rno = $("input[name='rno']").val();
			var replyDTO = {reply, replyer, rno};
			$.ajax({
				url: "/replies/modify",
				method: "PUT",
				data: JSON.stringify(replyDTO),
				contentType: "application/json;charset=utf-8",
				success: function(resData) {
					if(resData == "success"){
						alert("댓글 수정됨");
						$('.modal').hide();
						f_selectReplies();
					}
				},  error: function(e){
					console.log(e);
				}
			});
		}
		
		function f_replyModify() {
			$("input[name='rno']").val($(this).data("rno"));
			$("input[name='replyText']").val($(this).find(".card-title").html());
			$("input[name='replyer']").val($(this).find(".card-subtitle").html());
			$(".modal-footer button").hide();
			$(".replyModify, .replyRemove, .replyClose").show();
			$(".modal").attr("style", "display:block; background: #80808069;");
		}
		
		$(".addReply").on("click", function() {
			$(".modal-footer button").hide();
			$(".replySave, .replyClose").show();
			$(".modal").attr("style", "display:block; background: #80808069;");
			$("input[name='replyText']").val("");
			$("input[name='replyer']").val("");
		});
		
		$("[data-dismiss]").on("click", function() {
			$(".modal").attr("style", "display:none;");
		});
	
		$(".btnDelete").on("click", function() {
			var formObj = $("form");
			formObj.attr("action","delete");
			formObj.attr("method", "post");
			formObj.submit();
		});

		function f_insertReply() {
			var reply = $("input[name='replyText']").val();
			var replyer = $("input[name='replyer']").val();
			var replyDTO = {reply, replyer, boardBno};
			
			$.ajax({
				url : "/replies/register",
				method : "POST",
				data : JSON.stringify(replyDTO),
				contentType: "application/json;charset=utf-8",
				success : function(responseData) {
					alert(responseData + "번 댓글이 등록됨");
					location.reload();
				}, error : function(e) {
					console.log(e);
				}
			});
		}
		
		function f_selectReplies() {
			$.getJSON("/replies/list/"+boardBno, f_dataDisplay);
		}
		
		function f_formatDate(str) {
			var date = new Date(str);
			return date.getFullYear() + "/" + (date.getMonth() + 1) + "/" + date.getDate() + " "
					+ date.getHours() + ":" + date.getMinutes();
		}
		
		function f_dataDisplay(replyList) {
			console.log(replyList);
			var output = "";
			$.each(replyList, function(index, reply) {
				var rDt = f_formatDate(reply.regdate);
				var uDt = f_formatDate(reply.updatedate);
				output += `<div class='card card-body' data-rno='${reply.rno}' style="width: 18rem;"  >
					 				   <b>${reply.rno}</b>
					 				   <h5 class='card-title'>${reply.reply}</h5>
					 				   <h5 class='card-subtitle mb-2 text-muted'>${reply.replyer}</h5>
					 				   <p class='card-text mb-2 text-muted'> 등록일: ${rDt} </p>
					 				   <p class='card-text mb-2 text-muted'> 수정일: ${uDt} </p>
				 				 </div>
				`;
			});
			$(".replyList").html(output);
		}
		
	</script>
</body>
</html>